<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>LentSys Web Example</title>
    <style>
        html,
        body,
        canvas {
            width: 800px;
            height: 600px;
            position: absolute;
            background: black;
            outline: none;
            z-index: 0;
        }
    </style>
    
</head>

<body>
    <button id="example">Load</button>
    <canvas id="lentsys-canvas" width="320" height="240" tabindex='1'></canvas>
    <script type="module">
    import init, {BlSpy, PadControl} from "./pkg/buglympics.js";
    const wasm = await init();
    const w = 320;
    const h = 240;
    const imageDataSize = h * w * 4;
    const canvas = document.getElementById('lentsys-canvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled= false;
    const imageData = new ImageData(w, h);
    
    let lastFrame;
    let lsw;
    let game_pack_buffer;

    let apu;
    let audioCtx;
    let audioSrc;
    let audioLength;
    let audioBuffer;
    let controller = PadControl.new();

    document.querySelector('#example').addEventListener('click', loadExample);
    document.querySelector('canvas').addEventListener('keydown', handleInput);
    document.querySelector('canvas').addEventListener('keyup', handleInput);

    function loadExample(event){
        event.target.hidden = true;
        audioCtx = new window.AudioContext({ latencyHint: 0 });
        audioCtx.resume();
        audioSrc = audioCtx.createBufferSource();
        
        audioLength =  1 / 60 * audioCtx.sampleRate;
        audioBuffer = audioCtx.createBuffer(1, audioLength, audioCtx.sampleRate);
        audioSrc.buffer = audioBuffer;
        audioSrc.connect(audioCtx.destination);
        audioSrc.start();
        
        // Load the game pak binary
        fetch('buglympics.bin')
        .then(response => response && response.arrayBuffer())
        .then(buffer => {
            game_pack_buffer = new Uint8Array(buffer);

            lsw = BlSpy.new(game_pack_buffer);

            lastFrame = performance.now();
            render();
        })
    }

    function handleInput(event){
        event.preventDefault();
        
        let value = event.type == 'keydown' ? 255 : 0;

        const keyMap = {
            38: 'up',
            40: 'down',
            37: 'left',
            39: 'right',
            13: 'start',
            65: 'x',
            81: 'b',
            90: 'a'
        };

        if (event.keyCode in keyMap){
          controller[keyMap[event.keyCode]] = value;
        }
    }

    async function startAudio(){
        await audioCtx.audioWorklet.addModule("apu.js");
        
        apu = new AudioWorkletNode(audioCtx, 'apu-worklet', 
            {processorOptions: {wasmMemory: wasm.memory.buffer}}
        );
        apu.connect(audioCtx.destination);

        render();
    }

    function render(){

        // input
        lsw.set_inputs(controller);

        // update game
        lsw.update();

        // video
        lsw.render_image();
        const pixels = new Uint8Array(wasm.memory.buffer, lsw.get_image_data(), imageDataSize);
        imageData.data.set(pixels);
        ctx.putImageData(imageData, 0, 0);

        //audio
        renderAudio();

        
        
        // next frame
        window.requestAnimationFrame(render);
    }
    let lastPos = 0;
    function ringBuffer(timeDelta, sampleRate, oldBuffer, newSamples){
        
        let lastSamples = oldBuffer.getChannelData(0);
        
        let cPos = audioCtx.getOutputTimestamp().performanceTime / 1000;
        let delta = cPos - lastPos;
        let beginAt = Math.min(lastSamples.length - 1, Math.max(0, Math.ceil((oldBuffer.duration - delta) * sampleRate)));
        lastSamples = lastSamples.slice(beginAt);
        
        const samples = new Float32Array(lastSamples.length + newSamples.length);
        samples.set(lastSamples);
        samples.set(newSamples, lastSamples.length);
        lastPos = cPos;
        return samples;
    }

    function renderAudio(){
        // TODO: Fix some clicks and pops on playback
        
        let currentFrame = performance.now();
        let timeDelta =  (currentFrame - lastFrame) / 1000;
        lsw.render_audio(timeDelta);
        // This should match the number of samples generated
        audioLength = Math.floor(timeDelta * audioCtx.sampleRate);
        const newSamples = new Float32Array(wasm.memory.buffer, lsw.get_audio_data(), audioLength);
        const samples = ringBuffer(timeDelta, audioCtx.sampleRate, audioBuffer, newSamples);
        console.log(samples.length, audioLength);
        let newAudioBuffer = audioCtx.createBuffer(1, samples.length, audioCtx.sampleRate);
        
        newAudioBuffer.copyToChannel(samples, 0, 0);
        
        audioSrc.stop();
        audioSrc = audioCtx.createBufferSource();
        audioSrc.buffer = newAudioBuffer;
        let offset = (audioCtx.getOutputTimestamp().performanceTime / 1000 - lastPos);
        //console.log(audioSrc.playbackRate);
        audioSrc.start(0, offset);
        audioSrc.connect(audioCtx.destination);
        
        audioBuffer = newAudioBuffer;
        lastFrame = currentFrame;
    }
    </script>
</body>

</html>